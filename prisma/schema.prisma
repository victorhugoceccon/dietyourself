// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  password            String
  name                String?
  role                String   @default("PACIENTE") // ADMIN, NUTRICIONISTA, PERSONAL ou PACIENTE (role principal para compatibilidade)
  roles               String? // JSON array de roles: ["ADMIN", "NUTRICIONISTA", "PERSONAL", "PACIENTE"]
  profilePhoto        String? // URL ou base64 da foto de perfil
  motivationalMessage String? // Mensagem motivacional personalizada
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relacionamento com dados do question√°rio
  questionnaireData QuestionnaireData?
  dieta             Dieta?

  // Relacionamento nutricionista-paciente
  nutricionistaId        String? // ID do nutricionista respons√°vel (null se for nutricionista ou admin)
  nutricionista          User?   @relation("NutricionistaPaciente", fields: [nutricionistaId], references: [id], onDelete: SetNull)
  pacientesNutricionista User[]  @relation("NutricionistaPaciente") // Lista de pacientes deste nutricionista

  // Relacionamento personal-paciente
  personalId        String? // ID do personal trainer respons√°vel (null se for personal ou admin)
  personal          User?   @relation("PersonalPaciente", fields: [personalId], references: [id], onDelete: SetNull)
  pacientesPersonal User[]  @relation("PersonalPaciente") // Lista de pacientes deste personal

  // Relacionamento nutricionista-alimentos
  alimentos Alimento[] @relation("NutricionistaAlimentos") // Alimentos criados por este nutricionista

  // Relacionamento personal-exercicios
  exercicios     Exercicio[]     @relation("PersonalExercicios") // Exerc√≠cios criados por este personal
  divisoesTreino DivisaoTreino[] @relation("PersonalDivisoes") // Divis√µes de treino criadas por este personal

  // Relacionamento check-ins di√°rios
  dailyCheckIns DailyCheckIn[] // Check-ins di√°rios do paciente

  // Relacionamento refei√ß√µes consumidas
  consumedMeals ConsumedMeal[] // Refei√ß√µes consumidas pelo paciente

  // Relacionamento refei√ß√µes por foto
  photoMeals PhotoMeal[] // Refei√ß√µes identificadas por foto

  // Relacionamento prescri√ß√µes de treino (como personal trainer)
  prescricoesPersonal PrescricaoTreino[] @relation("PersonalPrescricoes")

  // Relacionamento prescri√ß√µes de treino (como paciente)
  prescricoesPaciente PrescricaoTreino[] @relation("PacientePrescricoes")

  // Relacionamento treinos executados (como paciente)
  treinosExecutados TreinoExecutado[] @relation("PacienteTreinosExecutados")

  // Relacionamento solicita√ß√µes de mudan√ßa (como paciente)
  solicitacoesPaciente SolicitacaoMudanca[] @relation("PacienteSolicitacoes")

  // Relacionamento solicita√ß√µes de mudan√ßa (como personal)
  solicitacoesPersonal SolicitacaoMudanca[] @relation("PersonalSolicitacoes")

  // Relacionamento branding settings
  brandingSettings BrandingSettings? @relation("UserBranding")

  // Relacionamento password reset tokens
  passwordResetTokens PasswordResetToken[] @relation("UserPasswordReset")

  // Relacionamento notifica√ß√µes
  notifications Notification[] @relation("UserNotifications")

  // Relacionamento grupos (gamifica√ß√£o)
  gruposCriados       Grupo[]              @relation("GruposCriados")
  gruposMembros       GrupoMembro[]        @relation("GrupoMembroUser")
  gruposPontosEventos GrupoPontosEvento[]  @relation("GrupoPontosEventoUser")
  grupoTreinoCheckIns GrupoTreinoCheckIn[] @relation("GrupoTreinoCheckInUser")
  grupoDietaCheckIns  GrupoDietaCheckIn[]  @relation("GrupoDietaCheckInUser")

  // Relacionamento social (rea√ß√µes e coment√°rios)
  checkInReactions CheckInReaction[] @relation("CheckInReactionUser")
  checkInComments  CheckInComment[]  @relation("CheckInCommentUser")

  // Relacionamento conquistas
  achievements UserAchievement[] @relation("UserAchievementUser")

  // Relacionamento stories
  stories Story[] @relation("StoryUser")

  // Relacionamento desafios
  challengeParticipations ChallengeParticipation[] @relation("ChallengeParticipationUser")

  // Relacionamento metas
  goals        Goal[]         @relation("GoalUser")
  goalProgress GoalProgress[] @relation("GoalProgressUser")

  // Relacionamento chat
  chatRooms    ChatRoomMember[] @relation("ChatRoomMemberUser")
  chatMessages ChatMessage[]    @relation("ChatMessageUser")

  // Relacionamento assinatura
  subscription Subscription? @relation("UserSubscription")

  // Relacionamento controle de gera√ß√£o
  generationControl GenerationControl? @relation("UserGenerationControl")

  @@index([nutricionistaId])
  @@index([personalId])
  @@map("users")
}

model QuestionnaireData {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Bloco 1: Dados B√°sicos
  idade     Int
  sexo      String? // Masculino / Feminino / Prefiro n√£o informar
  altura    Float // em cm
  pesoAtual Float // em kg
  objetivo  String // Emagrecer, Manter o peso, Ganhar massa muscular, Ganhar peso de forma geral

  // Sentimentos e Expectativas
  sentimentosCorpo   String? // Como se sente em rela√ß√£o ao corpo
  expectativaSucesso String? // O que faria o plano valer a pena em 30 dias

  // Rotina e Sono
  rotinaDiaria String // Descri√ß√£o da rotina di√°ria
  sono         String // Durmo bem, Durmo mal, Varia muito

  // Bloco 2: Atividade F√≠sica
  frequenciaAtividade          String // N√£o pratico atualmente, 1-2x, 3-4x, 5x ou mais
  barreirasTreino              String? // O que impede de treinar (se n√£o pratica)
  tipoAtividade                String? // Tipo de atividade (se pratica)
  relacaoEmocionalTreino       String? // Gosto, obriga√ß√£o, sempre paro
  preferenciaDificuldadeTreino String? // Prefer√™ncia ou dificuldade no treino
  rotinaTreinoDetalhada        String? // Descri√ß√£o detalhada da rotina de treino (legado)
  outraAtividade               String? // Se tipoAtividade for "Outro"
  horarioTreino                String // Manh√£, Tarde, Noite, Varia muito

  // Bloco 3: Estrutura da Dieta
  quantidadeRefeicoes  String // 3, 4, 5, Mais de 5
  preferenciaRefeicoes String // Mais simples, Um equil√≠brio, Mais completas e variadas

  // Bloco 4: Alimenta√ß√£o
  alimentosGosta       String? // Alimentos favoritos
  alimentosEvita       String? // Alimentos que evita
  tempoPreparacao      String // At√© 10 min, 10-30 min, Tenho tempo
  confortoPesar        String // Sim, √Äs vezes, Prefiro medidas caseiras
  preferenciaVariacao  String // Prefiro repetir, Um pouco de repeti√ß√£o, Prefiro muita variedade
  alimentacaoFimSemana String? // Parecida, Um pouco mais solta, Sai do controle

  // Bloco 5: Alimentos do Dia a Dia (JSON)
  alimentosDoDiaADia String? // JSON: { carboidratos: [], proteinas: [], gorduras: [], frutas: [] }

  // Bloco 6: Restri√ß√µes
  restricaoAlimentar String // Nenhuma, Intoler√¢ncia √† lactose, Intoler√¢ncia ao gl√∫ten, Outra
  outraRestricao     String? // Se selecionou "Outra"

  // Bloco 7: Flexibilidade Real
  opcoesSubstituicao String // Sim gosto, Algumas op√ß√µes, Prefiro fixo
  refeicoesLivres    String // Sim, Talvez, Prefiro seguir o plano √† risca

  // Bloco 8: Sa√∫de e Limita√ß√µes
  problemasSaude             String // N√£o, Sim
  quaisProblemasSaude        String? // Detalhes dos problemas de sa√∫de
  usoMedicacao               String // N√£o, Sim
  quaisMedicamentos          String? // Detalhes dos medicamentos
  limitacoesFisicas          String // N√£o, Sim
  detalhesLimitacao          String? // Detalhes da limita√ß√£o f√≠sica
  restricoesMedicasExercicio String // N√£o, Sim
  movimentosEvitar           String? // Movimentos a evitar
  receiosSaude               String? // Receios relacionados √† sa√∫de

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("questionnaire_data")
}

model Dieta {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados da dieta em JSON
  dietaData String // JSON completo da dieta gerada

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dietas")
}

model Alimento {
  id             String  @id @default(uuid())
  numero         Int? // N√∫mero do alimento no CSV
  categoria      String? // Categoria do alimento
  descricao      String // Descri√ß√£o do alimento
  umidade        Float?
  energiaKcal    Float // Energia em kcal por 100g
  energiaKj      Float?
  proteina       Float // Prote√≠na em g por 100g
  lipideos       Float // Lip√≠dios (gordura) em g por 100g
  colesterol     Float?
  carboidrato    Float // Carboidrato em g por 100g
  fibraAlimentar Float?
  cinzas         Float?

  // Criado por (nutricionista)
  nutricionistaId String? // ID do nutricionista que criou (null se importado do CSV)
  nutricionista   User?   @relation("NutricionistaAlimentos", fields: [nutricionistaId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nutricionistaId])
  @@map("alimentos")
}

model DailyCheckIn {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados do check-in
  adherence   String // "TOTAL", "PARCIAL", "NAO_SEGUIU"
  pesoAtual   Float? // Peso atual em kg (opcional)
  observacao  String? // Observa√ß√£o curta do dia (opcional, m√°ximo 500 caracteres)
  checkInDate DateTime @default(now()) // Data do check-in (apenas data, sem hora)

  // M√©tricas do dia (opcionais)
  nivelEnergia  Int? // 1-5
  qualidadeSono Int? // 1-5
  humorGeral    Int? // 1-5
  aguaLitros    Float? // Litros de √°gua no dia
  treinoMinutos Int? // Minutos de treino
  passos        Int? // Passos do dia

  // Plano do dia (inten√ß√£o)
  aguaMetaLitros  Float? // Meta de √°gua do dia (L)
  treinoPlanejado Boolean? // Planeja treinar hoje
  focoDia         String? // Foco do dia (ex: "Hidrata√ß√£o", "Disciplina")

  // Localiza√ß√£o
  locationName String? // Nome do local (ex: "Smart Fit - Shopping Center")
  locationLat  Float? // Latitude
  locationLng  Float? // Longitude

  // Foto do check-in
  photoUrl String? // URL ou base64 da foto do check-in

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Refei√ß√µes consumidas hoje (array de √≠ndices das refei√ß√µes: [0, 1, 2, ...])
  refeicoesConsumidas String? // JSON array: "[0, 1]" indica que consumiu refei√ß√£o √≠ndice 0 e 1

  @@unique([userId, checkInDate]) // Um check-in por dia por usu√°rio
  @@index([userId])
  @@index([checkInDate])
  @@map("daily_check_ins")
}

model ConsumedMeal {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados da refei√ß√£o consumida
  mealIndex    Int // √çndice da refei√ß√£o na dieta (0, 1, 2, ...)
  mealName     String // Nome da refei√ß√£o
  consumedDate DateTime @default(now()) // Data do consumo (apenas data, sem hora)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, mealIndex, consumedDate]) // Uma refei√ß√£o por dia por usu√°rio
  @@index([userId])
  @@index([consumedDate])
  @@map("consumed_meals")
}

model PhotoMeal {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Foto original (base64)
  photoUrl String // base64 da foto

  // An√°lise da IA
  alimentos    String // JSON: [{ nome, quantidade, quantidadeGramas, kcal, proteina, carboidrato, gordura }]
  totalKcal    Float
  totalProtein Float
  totalCarbs   Float
  totalFat     Float

  // Metadados
  consumedDate DateTime @default(now()) // Data do consumo (apenas data, sem hora)
  mealName     String? // Nome da refei√ß√£o (ex: "Almo√ßo extra", "Lanche")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([consumedDate])
  @@map("photo_meals")
}

model Exercicio {
  id          String  @id @default(uuid())
  nome        String // Nome do exerc√≠cio
  descricao   String? // Descri√ß√£o/instru√ß√µes do exerc√≠cio
  categoria   String? // Categoria (Peito, Costas, Pernas, etc)
  videoUrl    String? // URL do v√≠deo do exerc√≠cio (base64 ou URL)
  observacoes String? // Observa√ß√µes adicionais

  // Criado por (personal trainer)
  personalId String // ID do personal trainer que criou
  personal   User   @relation("PersonalExercicios", fields: [personalId], references: [id], onDelete: Cascade)

  // Campos para exerc√≠cios sincronizados da API
  source           String? // 'USER' ou 'ASCEND_API' - indica a origem do exerc√≠cio
  ascendExerciseId String? @unique // ID original do exerc√≠cio na Ascend API
  ascendData       String? // JSON com dados completos traduzidos da API

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento com prescri√ß√µes
  prescricoes       PrescricaoTreinoItem[]
  DivisaoTreinoItem DivisaoTreinoItem[]

  @@index([personalId])
  @@index([categoria])
  @@index([source])
  @@index([ascendExerciseId])
  @@map("exercicios")
}

model DivisaoTreino {
  id         String  @id @default(uuid())
  nome       String // Nome da divis√£o (ex: "A - Peito e Tr√≠ceps")
  descricao  String? // Descri√ß√£o da divis√£o
  diasSemana String? // Dias da semana que deve ser executada (JSON array)

  // Criado por (personal trainer)
  personalId String // ID do personal trainer que criou
  personal   User   @relation("PersonalDivisoes", fields: [personalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento com prescri√ß√µes
  prescricoes PrescricaoTreinoDivisao[]

  // Itens padr√£o (exerc√≠cios) desta divis√£o
  itens DivisaoTreinoItem[]

  @@index([personalId])
  @@map("divisoes_treino")
}

model DivisaoTreinoItem {
  id              String        @id @default(uuid())
  divisaoTreinoId String
  divisaoTreino   DivisaoTreino @relation(fields: [divisaoTreinoId], references: [id], onDelete: Cascade)

  exercicioId String
  exercicio   Exercicio @relation(fields: [exercicioId], references: [id], onDelete: Cascade)

  series      Int
  repeticoes  String?
  carga       String?
  descanso    String?
  observacoes String?
  ordem       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([divisaoTreinoId])
  @@index([exercicioId])
  @@map("divisoes_treino_itens")
}

model PrescricaoTreino {
  id         String @id @default(uuid())
  pacienteId String // ID do paciente
  paciente   User   @relation("PacientePrescricoes", fields: [pacienteId], references: [id], onDelete: Cascade)

  personalId String // ID do personal trainer que prescreveu
  personal   User   @relation("PersonalPrescricoes", fields: [personalId], references: [id], onDelete: Cascade)

  nome         String // Nome do treino (ex: "Treino A/B/C")
  observacoes  String? // Observa√ß√µes gerais do treino
  analysisJson String? // An√°lise visual e plano detalhado em JSON
  dataInicio   DateTime? // Data de in√≠cio do treino
  dataFim      DateTime? // Data de t√©rmino do treino (opcional)
  ativo        Boolean   @default(true) // Se o treino est√° ativo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  divisoes          PrescricaoTreinoDivisao[]
  treinosExecutados TreinoExecutado[]
  solicitacoes      SolicitacaoMudanca[]

  @@index([pacienteId])
  @@index([personalId])
  @@index([ativo])
  @@map("prescricoes_treino")
}

model PrescricaoTreinoDivisao {
  id           String           @id @default(uuid())
  prescricaoId String // ID da prescri√ß√£o
  prescricao   PrescricaoTreino @relation(fields: [prescricaoId], references: [id], onDelete: Cascade)

  divisaoTreinoId String? // ID da divis√£o de treino (opcional, pode criar divis√£o customizada)
  divisaoTreino   DivisaoTreino? @relation(fields: [divisaoTreinoId], references: [id], onDelete: SetNull)

  nome  String // Nome da divis√£o nesta prescri√ß√£o
  ordem Int // Ordem da divis√£o no treino (1, 2, 3...)

  // Metadados (opcionais) para ajudar na organiza√ß√£o/UX
  grupoMuscularPrincipal  String?
  grupoMuscularSecundario String?
  diaSemana               String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Itens (exerc√≠cios) desta divis√£o
  itens             PrescricaoTreinoItem[]
  treinosExecutados TreinoExecutado[]

  @@index([prescricaoId])
  @@index([divisaoTreinoId])
  @@map("prescricoes_treino_divisoes")
}

model PrescricaoTreinoItem {
  id        String                  @id @default(uuid())
  divisaoId String // ID da divis√£o
  divisao   PrescricaoTreinoDivisao @relation(fields: [divisaoId], references: [id], onDelete: Cascade)

  exercicioId String // ID do exerc√≠cio
  exercicio   Exercicio @relation(fields: [exercicioId], references: [id], onDelete: Cascade)

  series      Int // N√∫mero de s√©ries
  repeticoes  String? // Repeti√ß√µes (ex: "10-12", "at√© a falha")
  carga       String? // Carga (ex: "20kg", "60% 1RM")
  descanso    String? // Tempo de descanso (ex: "60s", "2min")
  observacoes String? // Observa√ß√µes espec√≠ficas deste exerc√≠cio na prescri√ß√£o
  ordem       Int // Ordem do exerc√≠cio na divis√£o

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([divisaoId])
  @@index([exercicioId])
  @@map("prescricoes_treino_itens")
}

model TreinoExecutado {
  id         String @id @default(uuid())
  pacienteId String // ID do paciente que executou
  paciente   User   @relation("PacienteTreinosExecutados", fields: [pacienteId], references: [id], onDelete: Cascade)

  prescricaoId String // ID da prescri√ß√£o de treino
  prescricao   PrescricaoTreino @relation(fields: [prescricaoId], references: [id], onDelete: Cascade)

  divisaoId String // ID da divis√£o executada
  divisao   PrescricaoTreinoDivisao @relation(fields: [divisaoId], references: [id], onDelete: Cascade)

  dataExecucao   DateTime @default(now()) // Data e hora da execu√ß√£o
  diaSemana      String // Dia da semana: "SEGUNDA", "TERCA", "QUARTA", "QUINTA", "SEXTA", "SABADO", "DOMINGO"
  finalizado     Boolean  @default(false) // Se o treino foi finalizado
  duracaoMinutos Int? // Dura√ß√£o do treino em minutos (salvo quando finalizado)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento com feedback
  feedback FeedbackTreino?

  // Relacionamento com check-ins de grupo
  grupoCheckIns GrupoTreinoCheckIn[] @relation("TreinoExecutadoCheckIns")

  @@unique([pacienteId, prescricaoId, divisaoId, dataExecucao]) // Um treino por dia por divis√£o
  @@index([pacienteId])
  @@index([prescricaoId])
  @@index([dataExecucao])
  @@index([diaSemana])
  @@map("treinos_executados")
}

model FeedbackTreino {
  id                String          @id @default(uuid())
  treinoExecutadoId String          @unique // ID do treino executado
  treinoExecutado   TreinoExecutado @relation(fields: [treinoExecutadoId], references: [id], onDelete: Cascade)

  observacao       String? // Observa√ß√£o livre sobre o treino
  intensidade      Int? // Intensidade percebida (1-10)
  dificuldade      Int? // Dificuldade percebida (1-10)
  satisfacao       Int? // Satisfa√ß√£o com o treino (1-10)
  completouTreino  Boolean @default(true) // Se completou todo o treino
  motivoIncompleto String? // Se n√£o completou, motivo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([treinoExecutadoId])
  @@map("feedback_treinos")
}

model SolicitacaoMudanca {
  id         String @id @default(uuid())
  pacienteId String // ID do paciente que solicitou
  paciente   User   @relation("PacienteSolicitacoes", fields: [pacienteId], references: [id], onDelete: Cascade)

  personalId String // ID do personal trainer
  personal   User   @relation("PersonalSolicitacoes", fields: [personalId], references: [id], onDelete: Cascade)

  prescricaoId String? // ID da prescri√ß√£o relacionada (opcional)
  prescricao   PrescricaoTreino? @relation(fields: [prescricaoId], references: [id], onDelete: SetNull)

  titulo   String // T√≠tulo da solicita√ß√£o
  mensagem String // Mensagem detalhada da solicita√ß√£o
  status   String  @default("PENDENTE") // PENDENTE, EM_ANALISE, RESOLVIDA, REJEITADA
  resposta String? // Resposta do personal (opcional)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pacienteId])
  @@index([personalId])
  @@index([status])
  @@map("solicitacoes_mudanca")
}

model BrandingSettings {
  id String @id @default(uuid())

  // Usu√°rio que possui essas configura√ß√µes (Personal ou Nutricionista)
  userId String @unique
  user   User   @relation("UserBranding", fields: [userId], references: [id], onDelete: Cascade)

  // Logo (URL ou base64)
  logoUrl String?

  // Banner (URL ou base64)
  bannerUrl String?

  // Cores personalizadas
  primaryColor   String? // Cor prim√°ria (hex)
  secondaryColor String? // Cor secund√°ria (hex)
  accentColor    String? // Cor de destaque (hex)

  // Nome da marca (opcional, se n√£o usar logo)
  brandName String?

  // Configura√ß√µes espec√≠ficas para √°rea do profissional
  professionalSettings String? // JSON com configura√ß√µes espec√≠ficas da √°rea do profissional

  // Configura√ß√µes espec√≠ficas para √°rea dos pacientes
  patientSettings String? // JSON com configura√ß√µes espec√≠ficas da √°rea dos pacientes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("branding_settings")
}

// ==========================================================
// Grupos / Projetos (Gamifica√ß√£o)
// ==========================================================

model Grupo {
  id            String    @id @default(uuid())
  nome          String
  descricao     String?
  bannerUrl     String? // URL ou base64 do banner do projeto
  codigoConvite String    @unique
  ativo         Boolean   @default(true)
  inicio        DateTime?
  fim           DateTime?

  criadoPorId String
  criadoPor   User   @relation("GruposCriados", fields: [criadoPorId], references: [id], onDelete: Cascade)

  membros       GrupoMembro[]
  pontosEventos GrupoPontosEvento[]
  checkIns      GrupoTreinoCheckIn[]
  dietaCheckIns GrupoDietaCheckIn[]
  stories       Story[]              @relation("StoryGrupo")
  challenges    Challenge[]          @relation("ChallengeGrupo")
  goals         Goal[]               @relation("GoalGrupo")
  chatRooms     ChatRoom[]           @relation("ChatRoomGrupo")
  achievements  UserAchievement[]    @relation("UserAchievementGrupo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([criadoPorId])
  @@index([codigoConvite])
  @@map("grupos")
}

model GrupoMembro {
  id      String @id @default(uuid())
  grupoId String
  grupo   Grupo  @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("GrupoMembroUser", fields: [userId], references: [id], onDelete: Cascade)

  papel    String   @default("MEMBRO") // DONO | ADMIN | MEMBRO
  joinedAt DateTime @default(now())

  @@unique([grupoId, userId])
  @@index([grupoId])
  @@index([userId])
  @@map("grupos_membros")
}

model GrupoPontosEvento {
  id      String @id @default(uuid())
  grupoId String
  grupo   Grupo  @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("GrupoPontosEventoUser", fields: [userId], references: [id], onDelete: Cascade)

  tipo           String // CHECKIN_TOTAL | CHECKIN_PARCIAL | TREINO_COMPLETO | TREINO_INCOMPLETO | AJUSTE_MANUAL
  pontos         Int
  referenciaTipo String // DAILY_CHECKIN | TREINO_EXECUTADO | MANUAL
  referenciaId   String // ID do registro de origem (ex: dailyCheckIn.id, treinoExecutado.id)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([grupoId, referenciaTipo, referenciaId])
  @@index([grupoId])
  @@index([userId])
  @@index([createdAt])
  @@map("grupos_pontos_eventos")
}

model GrupoTreinoCheckIn {
  id      String @id @default(uuid())
  grupoId String
  grupo   Grupo  @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("GrupoTreinoCheckInUser", fields: [userId], references: [id], onDelete: Cascade)

  // Dados do check-in
  photoUrl    String? // URL ou base64 da foto
  title       String? // T√≠tulo do check-in
  description String? // Descri√ß√£o/observa√ß√£o

  // Localiza√ß√£o
  locationName String? // Nome do local (ex: "Smart Fit - Shopping Center")
  locationLat  Float? // Latitude
  locationLng  Float? // Longitude

  // Atividade e m√©tricas
  activity String? // Tipo de atividade (ex: "Muscula√ß√£o", "Corrida", "Nata√ß√£o")
  duration Int? // Dura√ß√£o em minutos
  distance Float? // Dist√¢ncia em km
  calories Int? // Calorias queimadas
  steps    Int? // Passos dados

  // Link opcional para treino executado
  treinoExecutadoId String?
  treinoExecutado   TreinoExecutado? @relation("TreinoExecutadoCheckIns", fields: [treinoExecutadoId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos sociais
  reactions CheckInReaction[] @relation("CheckInReactionCheckIn")
  comments  CheckInComment[]  @relation("CheckInCommentCheckIn")

  @@index([grupoId])
  @@index([userId])
  @@index([createdAt])
  @@map("grupos_treino_check_ins")
}

// Check-in de dieta nos grupos
model GrupoDietaCheckIn {
  id      String @id @default(uuid())
  grupoId String
  grupo   Grupo  @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("GrupoDietaCheckInUser", fields: [userId], references: [id], onDelete: Cascade)

  // Link para PhotoMeal
  photoMealId String? // ID do PhotoMeal relacionado

  // Dados do check-in
  photoUrl    String? // URL ou base64 da foto
  title       String? // T√≠tulo do check-in
  description String? // Descri√ß√£o/observa√ß√£o

  // Dados nutricionais (do PhotoMeal ou manual)
  totalKcal    Float?
  totalProtein Float?
  totalCarbs   Float?
  totalFat     Float?
  mealName     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([grupoId])
  @@index([userId])
  @@index([createdAt])
  @@map("grupos_dieta_check_ins")
}

// Rea√ß√µes nos check-ins
model CheckInReaction {
  id        String             @id @default(uuid())
  checkInId String
  checkIn   GrupoTreinoCheckIn @relation("CheckInReactionCheckIn", fields: [checkInId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("CheckInReactionUser", fields: [userId], references: [id], onDelete: Cascade)

  emoji String // üî•, üí™, üëè, üéØ, ‚ö°, ‚ù§Ô∏è

  createdAt DateTime @default(now())

  @@unique([checkInId, userId, emoji]) // Um usu√°rio s√≥ pode reagir uma vez com cada emoji
  @@index([checkInId])
  @@index([userId])
  @@map("check_in_reactions")
}

// Coment√°rios nos check-ins
model CheckInComment {
  id        String             @id @default(uuid())
  checkInId String
  checkIn   GrupoTreinoCheckIn @relation("CheckInCommentCheckIn", fields: [checkInId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("CheckInCommentUser", fields: [userId], references: [id], onDelete: Cascade)

  content  String // Conte√∫do do coment√°rio
  parentId String? // ID do coment√°rio pai (para respostas)
  parent   CheckInComment?  @relation("CheckInCommentReply", fields: [parentId], references: [id], onDelete: Cascade)
  replies  CheckInComment[] @relation("CheckInCommentReply")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([checkInId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("check_in_comments")
}

// Conquistas dispon√≠veis
model Achievement {
  id          String @id @default(uuid())
  code        String @unique // C√≥digo √∫nico: STREAK_7, WORKOUTS_100, etc.
  name        String // Nome da conquista
  description String // Descri√ß√£o
  icon        String // Emoji ou √≠cone
  category    String // TREINO, DIETA, CONSISTENCIA, SOCIAL, etc.
  points      Int    @default(0) // Pontos extras ao desbloquear

  userAchievements UserAchievement[] @relation("UserAchievementAchievement")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([category])
  @@map("achievements")
}

// Conquistas do usu√°rio
model UserAchievement {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("UserAchievementUser", fields: [userId], references: [id], onDelete: Cascade)

  achievementId String
  achievement   Achievement @relation("UserAchievementAchievement", fields: [achievementId], references: [id], onDelete: Cascade)

  grupoId String? // Se a conquista foi desbloqueada em um grupo espec√≠fico
  grupo   Grupo?  @relation("UserAchievementGrupo", fields: [grupoId], references: [id], onDelete: Cascade)

  unlockedAt DateTime @default(now())

  @@unique([userId, achievementId, grupoId])
  @@index([userId])
  @@index([achievementId])
  @@index([grupoId])
  @@map("user_achievements")
}

// Stories (24 horas)
model Story {
  id     String @id @default(uuid())
  userId String
  user   User   @relation("StoryUser", fields: [userId], references: [id], onDelete: Cascade)

  grupoId String
  grupo   Grupo  @relation("StoryGrupo", fields: [grupoId], references: [id], onDelete: Cascade)

  photoUrl String // URL ou base64 da foto/v√≠deo
  type     String  @default("IMAGE") // IMAGE, VIDEO
  caption  String? // Legenda

  expiresAt DateTime // Expira em 24 horas
  views     Int      @default(0) // Contador de visualiza√ß√µes

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([grupoId])
  @@index([expiresAt])
  @@map("stories")
}

// Desafios semanais
model Challenge {
  id      String @id @default(uuid())
  grupoId String
  grupo   Grupo  @relation("ChallengeGrupo", fields: [grupoId], references: [id], onDelete: Cascade)

  createdBy   String // ID do criador
  name        String // Nome do desafio
  description String? // Descri√ß√£o
  type        String // STEPS, WORKOUTS, DIET, CUSTOM
  target      Int // Meta (ex: 10000 passos, 5 treinos)
  startDate   DateTime // Data de in√≠cio
  endDate     DateTime // Data de fim

  pointsReward Int @default(50) // Pontos ao completar

  participations ChallengeParticipation[] @relation("ChallengeParticipationChallenge")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([grupoId])
  @@index([startDate])
  @@index([endDate])
  @@map("challenges")
}

// Participa√ß√£o em desafios
model ChallengeParticipation {
  id          String    @id @default(uuid())
  challengeId String
  challenge   Challenge @relation("ChallengeParticipationChallenge", fields: [challengeId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("ChallengeParticipationUser", fields: [userId], references: [id], onDelete: Cascade)

  progress    Int       @default(0) // Progresso atual
  completed   Boolean   @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
  @@map("challenge_participations")
}

// Metas pessoais e coletivas
model Goal {
  id      String  @id @default(uuid())
  grupoId String?
  grupo   Grupo?  @relation("GoalGrupo", fields: [grupoId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("GoalUser", fields: [userId], references: [id], onDelete: Cascade)

  type        String // PERSONAL, GROUP
  category    String // WEIGHT, WORKOUTS, DIET, STREAK, CUSTOM
  name        String // Nome da meta
  description String? // Descri√ß√£o
  target      Float // Valor alvo
  unit        String // kg, treinos, dias, etc.
  startDate   DateTime
  endDate     DateTime

  progress GoalProgress[] @relation("GoalProgressGoal")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([grupoId])
  @@index([userId])
  @@index([endDate])
  @@map("goals")
}

// Progresso das metas
model GoalProgress {
  id     String @id @default(uuid())
  goalId String
  goal   Goal   @relation("GoalProgressGoal", fields: [goalId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("GoalProgressUser", fields: [userId], references: [id], onDelete: Cascade)

  value Float // Valor atual
  date  DateTime @default(now())
  notes String? // Observa√ß√µes

  createdAt DateTime @default(now())

  @@index([goalId])
  @@index([userId])
  @@index([date])
  @@map("goal_progress")
}

// Salas de chat
model ChatRoom {
  id      String @id @default(uuid())
  grupoId String
  grupo   Grupo  @relation("ChatRoomGrupo", fields: [grupoId], references: [id], onDelete: Cascade)

  name String? // Nome da sala (opcional, pode ser "Chat do Projeto")
  type String  @default("GROUP") // GROUP, DIRECT

  members  ChatRoomMember[] @relation("ChatRoomMemberRoom")
  messages ChatMessage[]    @relation("ChatMessageRoom")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([grupoId])
  @@map("chat_rooms")
}

// Membros da sala de chat
model ChatRoomMember {
  id     String   @id @default(uuid())
  roomId String
  room   ChatRoom @relation("ChatRoomMemberRoom", fields: [roomId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("ChatRoomMemberUser", fields: [userId], references: [id], onDelete: Cascade)

  joinedAt   DateTime  @default(now())
  lastReadAt DateTime? // √öltima vez que leu as mensagens

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@map("chat_room_members")
}

// Mensagens do chat
model ChatMessage {
  id     String   @id @default(uuid())
  roomId String
  room   ChatRoom @relation("ChatMessageRoom", fields: [roomId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("ChatMessageUser", fields: [userId], references: [id], onDelete: Cascade)

  content String // Conte√∫do da mensagem
  type    String @default("TEXT") // TEXT, IMAGE, CHECKIN_SHARE

  // Se for compartilhamento de check-in
  checkInId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roomId])
  @@index([userId])
  @@index([createdAt])
  @@map("chat_messages")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("UserPasswordReset", fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Notification {
  id       String  @id @default(uuid())
  userId   String
  user     User    @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  type     String  @default("default") // diet, checkin, workout, feedback, default
  message  String
  read     Boolean @default(false)
  metadata String? // JSON para dados extras (ex: link, pacienteId)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model DietTemplate {
  id              String  @id @default(uuid())
  nutricionistaId String
  name            String
  description     String?
  objetivo        String? // Emagrecer, Manter, Ganhar massa, etc.
  kcalRange       String? // Ex: "1500-1800"
  templateData    String // JSON com estrutura completa da dieta (refei√ß√µes, alimentos)
  isPublic        Boolean @default(false) // Se pode ser compartilhado com outros nutricionistas
  usageCount      Int     @default(0) // Quantas vezes foi usado

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nutricionistaId])
  @@index([objetivo])
  @@map("diet_templates")
}

model BodyMeasurement {
  id     String @id @default(uuid())
  userId String

  // Peso e composi√ß√£o
  peso              Float? // kg
  percentualGordura Float? // %
  massaMagra        Float? // kg

  // Circunfer√™ncias (cm)
  cintura        Float?
  quadril        Float?
  bracoEsquerdo  Float?
  bracoDireito   Float?
  coxaEsquerda   Float?
  coxaDireita    Float?
  panturrilhaEsq Float?
  panturrilhaDir Float?
  peitoral       Float?

  // Extras
  imc   Float? // Calculado
  rcq   Float? // Rela√ß√£o cintura/quadril
  notas String? // Observa√ß√µes do profissional

  // Foto de progresso (base64 ou URL)
  fotoFrente  String?
  fotoLateral String?
  fotoCostas  String?

  dataRegistro DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([dataRegistro])
  @@map("body_measurements")
}

model Recipe {
  id          String  @id @default(uuid())
  authorId    String? // Nutricionista que criou (null = sistema)
  name        String
  description String?
  category    String // Caf√© da Manh√£, Almo√ßo, Lanche, Jantar, Sobremesa
  difficulty  String  @default("F√°cil") // F√°cil, M√©dio, Dif√≠cil
  prepTime    Int? // Tempo de preparo em minutos
  cookTime    Int? // Tempo de cozimento em minutos
  servings    Int     @default(1) // Por√ß√µes

  // Valores nutricionais por por√ß√£o
  kcal       Int?
  proteina_g Float?
  carbo_g    Float?
  gordura_g  Float?
  fibra_g    Float?

  // Conte√∫do
  ingredients String // JSON array de ingredientes
  steps       String // JSON array de passos
  tips        String? // Dicas opcionais
  imageUrl    String? // URL da foto da receita

  // Tags para filtragem
  tags String? // JSON array: ["low-carb", "high-protein", "vegano", etc]

  // Estat√≠sticas
  viewCount     Int @default(0)
  favoriteCount Int @default(0)

  isPublic   Boolean @default(true)
  isApproved Boolean @default(true) // Para modera√ß√£o futura

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([authorId])
  @@index([tags])
  @@map("recipes")
}

model RecipeFavorite {
  id        String   @id @default(uuid())
  userId    String
  recipeId  String
  createdAt DateTime @default(now())

  @@unique([userId, recipeId])
  @@index([userId])
  @@map("recipe_favorites")
}

// ==========================================================
// Assinaturas (Subscription)
// ==========================================================

model Subscription {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserSubscription", fields: [userId], references: [id], onDelete: Cascade)

  // Tipo do plano
  plan String @default("FREE_TRIAL") // FREE_TRIAL, MONTHLY, YEARLY, LIFETIME

  // Status da assinatura
  status String @default("TRIAL") // TRIAL, ACTIVE, CANCELLED, EXPIRED, SUSPENDED

  // Datas do trial
  trialStartDate DateTime?
  trialEndDate   DateTime?

  // Datas da assinatura paga
  startDate DateTime?
  endDate   DateTime?

  // Dados de pagamento (para integra√ß√£o futura com Stripe/outro gateway)
  paymentProvider        String? // STRIPE, MERCADOPAGO, MANUAL
  externalCustomerId     String? // ID do cliente no gateway de pagamento
  externalSubscriptionId String? // ID da assinatura no gateway

  // Pre√ßo pago (em centavos para evitar problemas de ponto flutuante)
  pricePaidCents Int?
  currency       String? @default("BRL")

  // Hist√≥rico
  cancelledAt  DateTime?
  cancelReason String?

  // Metadados
  metadata String? // JSON para dados extras

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([plan])
  @@index([trialEndDate])
  @@map("subscriptions")
}

// ==========================================================
// Controle de Gera√ß√£o de Dieta e Treino
// ==========================================================

model GenerationControl {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserGenerationControl", fields: [userId], references: [id], onDelete: Cascade)

  // Data da √∫ltima gera√ß√£o de dieta
  lastDietGeneration DateTime?

  // Data da √∫ltima gera√ß√£o de treino
  lastWorkoutGeneration DateTime?

  // Data do √∫ltimo reset
  lastReset DateTime?

  // Quantidade de resets dispon√≠veis (1 por m√™s ap√≥s gerar dieta/treino)
  resetsAvailable Int @default(1)

  // Data da pr√≥xima gera√ß√£o permitida (1 m√™s ap√≥s √∫ltima gera√ß√£o)
  nextGenerationAllowed DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("generation_controls")
}
